<div class="h-full flex flex-col bg-gray-50 pb-14">

  <!-- HEADER -->
  <app-header title="Confirmar Pedido" backLink="/cart" />

  <!-- CONTENIDO -->
  <div class="flex-1 overflow-y-auto px-4 py-5">
    <div class="max-w-md mx-auto space-y-4">

      <!-- INFO DE MESA -->
      <div class="
        bg-linear-to-r from-orange-50 to-amber-50
        border border-orange-200
        rounded-2xl
        px-4 py-3
        flex items-center gap-3
      ">
        <div class="
          w-12 h-12
          bg-orange-500
          rounded-xl
          flex items-center justify-center
          text-white text-xl font-bold
          shadow-md
        ">
          {{ mesa()?.numero || '??' }}
        </div>
        <div class="flex-1">
          <p class="text-sm font-semibold text-gray-900">
            Mesa {{ mesa()?.numero || '??' }}
          </p>
          <p class="text-xs text-gray-600">
            {{ user()?.nombre || 'Cliente' }}
          </p>
        </div>
      </div>

      <!-- RESUMEN DE PRODUCTOS -->
      <div class="
        bg-white
        rounded-2xl
        border border-gray-200
        shadow-sm
        overflow-hidden
      ">
        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50">
          <h3 class="font-bold text-gray-900">
            Resumen del pedido
          </h3>
        </div>

        <div class="divide-y divide-gray-100">
          @for(item of cartItems(); track item.producto.producto_id) {
            <div class="px-5 py-3 flex items-start gap-3">
              <!-- Cantidad -->
              <div class="
                w-8 h-8
                bg-orange-500 text-white
                rounded-lg
                flex items-center justify-center
                font-bold text-sm
                shrink-0
              ">
                {{ item.cantidad }}
              </div>

              <!-- Info del producto -->
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-900 text-sm mb-0.5">
                  {{ item.producto.nombre }}
                </h4>
                @if(item.notas) {
                  <p class="text-xs text-gray-600 mb-1">
                    üìù {{ item.notas }}
                  </p>
                }
                <p class="text-xs text-gray-500">
                  ${{ item.producto.precio_unitario | number }} c/u
                </p>
              </div>

              <!-- Precio total del item -->
              <div class="text-right shrink-0">
                <p class="font-bold text-gray-900">
                  ${{ item.producto.precio_unitario * item.cantidad | number }}
                </p>
              </div>
            </div>
          }
        </div>

        <!-- Totales -->
        <div class="px-5 py-4 bg-gray-50 border-t border-gray-100 space-y-2">
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">Subtotal</span>
            <span class="font-semibold text-gray-900">
              ${{ subtotal() | number }}
            </span>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">IVA (21%)</span>
            <span class="font-semibold text-gray-900">
              ${{ iva() | number }}
            </span>
          </div>

          <div class="border-t border-gray-200 pt-2 mt-2"></div>

          <div class="flex items-center justify-between">
            <span class="font-bold text-gray-900 text-lg">Total</span>
            <span class="text-2xl font-black text-orange-600">
              ${{ total() | number }}
            </span>
          </div>
        </div>
      </div>

      <!-- M√âTODO DE PAGO -->
      <div class="
        bg-white
        rounded-2xl
        border border-gray-200
        shadow-sm
        overflow-hidden
      ">
        <div class="px-5 py-4 border-b border-gray-100">
          <h3 class="font-bold text-gray-900">
            M√©todo de pago
          </h3>
          <p class="text-xs text-gray-600 mt-0.5">
            Seleccion√° c√≥mo quer√©s pagar
          </p>
        </div>

        <div class="p-4 space-y-3">
          <!-- Opci√≥n: Efectivo -->
          <button
            (click)="selectPaymentMethod('efectivo')"
            [class.border-orange-500]="selectedPayment() === 'efectivo'"
            [class.bg-orange-50]="selectedPayment() === 'efectivo'"
            [class.border-gray-200]="selectedPayment() !== 'efectivo'"
            class="
              w-full
              p-4
              border-2
              rounded-xl
              flex items-center gap-4
              transition-all
              active:scale-[0.98]
            "
          >
            <!-- √çcono -->
            <div 
              [class.bg-orange-500]="selectedPayment() === 'efectivo'"
              [class.bg-gray-100]="selectedPayment() !== 'efectivo'"
              class="
                w-12 h-12
                rounded-xl
                flex items-center justify-center
                shrink-0
                transition-colors
              "
            >
              <lucide-icon 
                [img]="Banknote" 
                class="w-6 h-6" 
                [class.text-white]="selectedPayment() === 'efectivo'"
                [class.text-gray-600]="selectedPayment() !== 'efectivo'"
              ></lucide-icon>
            </div>

            <!-- Info -->
            <div class="flex-1 text-left">
              <p 
                [class.text-orange-900]="selectedPayment() === 'efectivo'"
                [class.text-gray-900]="selectedPayment() !== 'efectivo'"
                class="font-bold text-sm mb-0.5"
              >
                Efectivo
              </p>
              <p class="text-xs text-gray-600">
                Pag√°s al mozo cuando te atienda
              </p>
            </div>

            <!-- Checkmark -->
            @if(selectedPayment() === 'efectivo') {
              <div class="
                w-6 h-6
                bg-orange-500 text-white
                rounded-full
                flex items-center justify-center
              ">
                <lucide-icon [img]="Check" class="w-4 h-4" ></lucide-icon>
              </div>
            }

          </button>

          <!-- Opci√≥n: QR / App -->
          <button
            (click)="selectPaymentMethod('app')"
            [class.border-orange-500]="selectedPayment() === 'app'"
            [class.bg-orange-50]="selectedPayment() === 'app'"
            [class.border-gray-200]="selectedPayment() !== 'app'"
            class="
              w-full
              p-4
              border-2
              rounded-xl
              flex items-center gap-4
              transition-all
              active:scale-[0.98]
            "
          >
            <!-- √çcono -->
            <div 
              [class.bg-orange-500]="selectedPayment() === 'app'"
              [class.bg-gray-100]="selectedPayment() !== 'app'"
              class="
                w-12 h-12
                rounded-xl
                flex items-center justify-center
                shrink-0
                transition-colors
              "
            >
                <lucide-icon 
                  [img]="QrCode" 
                  class="w-6 h-6" 
                  [class.text-white]="selectedPayment() === 'app'"
                  [class.text-gray-600]="selectedPayment() !== 'app'"
                ></lucide-icon>
            </div>

            <!-- Info -->
            <div class="flex-1 text-left">
              <p 
                [class.text-orange-900]="selectedPayment() === 'app'"
                [class.text-gray-900]="selectedPayment() !== 'app'"
                class="font-bold text-sm mb-0.5"
              >
                Mercado Pago / QR
              </p>
              <p class="text-xs text-gray-600">
                El mozo te acercar√° el QR para pagar
              </p>
            </div>

            <!-- Checkmark -->
            @if(selectedPayment() === 'app') {
              <div class="
                w-6 h-6
                bg-orange-500 text-white
                rounded-full
                flex items-center justify-center
              ">
                <lucide-icon [img]="Check" class="w-4 h-4" ></lucide-icon>
              </div>
            }
          </button>
        </div>
      </div>

      <!-- Nota adicional (opcional) -->
      <div class="
        bg-white
        rounded-2xl
        border border-gray-200
        shadow-sm
        p-4
      ">
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Nota para la cocina (opcional)
        </label>
        <textarea
          [(ngModel)]="notaGeneral"
          placeholder="Ej: Por favor preparar todos juntos..."
          rows="3"
          maxlength="200"
          class="
            w-full
            px-4 py-3
            text-sm
            bg-gray-50
            border border-gray-200
            rounded-xl
            focus:border-orange-500 focus:bg-white focus:outline-none
            resize-none
            transition
          "
        ></textarea>
        <p class="text-xs text-gray-500 mt-1.5 text-right">
          {{ notaGeneral().length }}/200
        </p>
      </div>

    </div>
  </div>

  <!-- FOOTER CON BOT√ìN DE CONFIRMAR -->
  <div class="
    bg-white
    border-t border-gray-200
    px-4 py-4
    pb-safe-bottom
    shadow-[0_-4px_12px_rgba(0,0,0,0.05)]
  ">
    <div class="max-w-md mx-auto space-y-3">
      <!-- Resumen r√°pido -->
      <div class="flex items-center justify-between px-2">
        <span class="text-sm text-gray-600">
          {{ getTotalItems() }} producto{{ getTotalItems() !== 1 ? 's' : '' }}
        </span>
        <span class="text-xl font-bold text-orange-600">
          ${{ total() | number }}
        </span>
      </div>

      <!-- Bot√≥n confirmar -->
      <button
        [disabled]="!selectedPayment() || isProcessing()"
        (click)="confirmOrder()"
        class="
          w-full h-14
          bg-linear-to-r from-orange-500 to-red-500
          text-white text-lg font-bold
          rounded-xl
          shadow-lg shadow-orange-500/30
          disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed
          active:scale-[0.98]
          transition-all
          flex items-center justify-center gap-2
        "
      >
        @if(isProcessing()) {
          <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span>Procesando...</span>
        } @else {
          <lucide-icon [img]="Check" class="w-6 h-6" ></lucide-icon>
          <span>Confirmar pedido</span>
        }
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
@if(showConfirmation()) {
  <div 
    class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4"
  >
    <div 
      class="
        bg-white
        rounded-3xl
        p-8
        max-w-sm
        w-full
        shadow-2xl
        animate-scale-in
      "
    >
      <!-- √çcono de √©xito -->
      <div class="
        w-20 h-20
        bg-green-100
        rounded-full
        flex items-center justify-center
        mx-auto
        mb-6
      ">
        <lucide-icon [img]="Check" class="w-10 h-10 text-green-600" ></lucide-icon>
      </div>

      <!-- T√≠tulo -->
      <h2 class="text-2xl font-bold text-gray-900 text-center mb-3">
        ¬°Pedido confirmado!
      </h2>

      <!-- N√∫mero de pedido -->
      <div class="
        bg-gray-50
        rounded-xl
        p-4
        mb-4
        text-center
      ">
        <p class="text-xs text-gray-600 mb-1">N√∫mero de pedido</p>
        <p class="text-3xl font-black text-orange-600">
            {{ pedidoNuevo()?.numero_pedido || '---' }}
        </p>
      </div>

      <!-- Mensaje seg√∫n m√©todo de pago -->
      <div class="text-center mb-6">
        @if(selectedPayment() === 'efectivo') {
          <p class="text-gray-700 mb-2">
            Tu pedido est√° siendo preparado.
          </p>
          <p class="text-sm text-gray-600">
            üí∞ Un mozo te cobrar√° cuando te lo lleve a la mesa.
          </p>
        } @else {
          <p class="text-gray-700 mb-2">
            Tu pedido est√° siendo preparado.
          </p>
          <p class="text-sm text-gray-600">
            üì± Un mozo te acercar√° el QR de Mercado Pago para que pagues.
          </p>
        }
      </div>

      <!-- Info adicional -->
      <div class="
        bg-blue-50
        border border-blue-200
        rounded-xl
        p-4
        mb-6
        flex items-start gap-3
      ">
        <lucide-icon [img]="Info" class="w-5 h-5 text-blue-600 shrink-0 mt-0.5" ></lucide-icon>
        <p class="text-xs text-blue-800">
          Pod√©s seguir el estado de tu pedido en tiempo real desde la secci√≥n "Mis Pedidos".
        </p>
      </div>

      <!-- Bot√≥n para ir a mesa -->
      <button
        routerLink="/table"
        class="
          w-full h-14
          bg-linear-to-r from-orange-500 to-red-500
          text-white text-lg font-bold
          rounded-xl
          shadow-lg shadow-orange-500/30
          active:scale-95
          transition
          flex items-center justify-center gap-2
        "
      >
        <lucide-icon [img]="Clipboard" class="w-6 h-6" ></lucide-icon>
        Ver resumen de mesa
      </button>

      <!-- Link alternativo -->
      <button
        routerLink="/menu"
        class="
          w-full h-12
          text-gray-600
          font-medium
          text-sm
          mt-3
          active:text-gray-900
        "
      >
        Volver al men√∫
      </button>
    </div>
  </div>
}