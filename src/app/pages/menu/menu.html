<div class="h-full flex flex-col bg-gray-50 pb-14">
  
  <!-- HEADER STICKY -->
  <app-header></app-header>

  <!-- BARRA DE B칔SQUEDA Y CONTROLES -->
  <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-14 z-30">
    <!-- Buscador -->
    <div class="relative mb-3">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <lucide-icon [img]="Search" class="w-5 h-5 text-gray-400"></lucide-icon>
      </div>
      <input
        type="text"
        placeholder="Buscar productos..."
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)"
        class="
          w-full h-10
          pl-10 pr-4
          text-sm
          bg-gray-50
          border border-gray-200
          rounded-xl
          focus:border-orange-500 focus:bg-white focus:outline-none
          transition
        "
      />
    </div>
    
    <!-- Controles de vista y filtros -->
    <div class="flex items-center gap-2">
      <!-- Bot칩n de filtros -->
      <button
        (click)="toggleFilters()"
        class="
          flex items-center gap-1.5
          px-3 h-9
          bg-gray-100 text-gray-700
          text-sm font-medium
          rounded-lg
          active:bg-gray-200
          transition
        "
      >
        <lucide-icon [img]="Funnel" class="w-4 h-4"></lucide-icon>
        Filtros
        @if(activeFiltersCount() > 0) {
          <span 
            class="ml-1 w-5 h-5 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center"
          >
            {{ activeFiltersCount() }}
          </span>
        }
      </button>
      
      <!-- Bot칩n de ordenamiento -->
      <button
        (click)="toggleSort()"
        class="
          flex items-center gap-1.5
          px-3 h-9
          bg-gray-100 text-gray-700
          text-sm font-medium
          rounded-lg
          active:bg-gray-200
          transition
        "
      >
        <lucide-icon [img]="ArrowDownWideNarrow" class="w-4 h-4"></lucide-icon>
        Ordenar
      </button>
      
      <div class="flex-1"></div>
      
      <!-- Toggle vista: Lista / Grilla -->
      <div class="flex bg-gray-100 rounded-lg p-1">
        <button
          (click)="viewMode.set('list')"
          [class.bg-white]="viewMode() === 'list'"
          [class.shadow-sm]="viewMode() === 'list'"
          class="
            w-8 h-7
            flex items-center justify-center
            rounded-md
            transition
          "
        >
          <lucide-icon [img]="List" class="w-4 h-4"></lucide-icon>
        </button>
        <button
          (click)="viewMode.set('grid')"
          [class.bg-white]="viewMode() === 'grid'"
          [class.shadow-sm]="viewMode() === 'grid'"
          class="
            w-8 h-7
            flex items-center justify-center
            rounded-md
            transition
          "
        >
          <lucide-icon [img]="LayoutGrid" class="w-4 h-4"></lucide-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- PANEL DE FILTROS (colapsable) -->
  @if(showFilters()) {
    <div class="bg-white border-b border-gray-200 px-4 py-4 space-y-3">
      <!-- Filtro por categor칤a -->
      <div>
        <label class="block text-xs font-semibold text-gray-700 mb-2">
          Categor칤a
        </label>
        <div class="flex flex-wrap gap-2">
          @for (cat of productoService.todasLasCategorias(); track cat){
            <button
              (click)="toggleCategoria(cat.categoria_id)"
              [class.bg-orange-500]="isCategoriaSelected(cat.categoria_id)"
              [class.text-white]="isCategoriaSelected(cat.categoria_id)"
              [class.bg-gray-100]="!isCategoriaSelected(cat.categoria_id)"
              [class.text-gray-700]="!isCategoriaSelected(cat.categoria_id)"
              class="
                px-3 py-1.5
                text-sm font-medium
                rounded-full
                transition
              "
            >
              {{ cat.emoji }} {{ cat.nombre }}
            </button>
          }
        </div>
      </div>
      
      <!-- Filtro por rango de precio -->
      <div>
        <label class="block text-xs font-semibold text-gray-700 mb-2">
          Rango de precio
        </label>
        <div class="flex gap-2 items-center">
          <input
            type="number"
            placeholder="M칤n"
            [ngModel]="precioMin()"
            (ngModelChange)="precioMin.set($event)"
            class="
              flex-1 h-9
              px-3
              text-sm
              bg-gray-50
              border border-gray-200
              rounded-lg
              focus:border-orange-500 focus:outline-none
            "
          />
          <span class="text-gray-400">-</span>
          <input
            type="number"
            placeholder="M치x"
            [ngModel]="precioMax()"
            (ngModelChange)="precioMax.set($event)"
            class="
              flex-1 h-9
              px-3
              text-sm
              bg-gray-50
              border border-gray-200
              rounded-lg
              focus:border-orange-500 focus:outline-none
            "
          />
        </div>
      </div>
      
      <!-- Bot칩n limpiar filtros -->
      @if(activeFiltersCount() > 0) {
        <button
          (click)="clearFilters()"
          class="
            w-full h-9
            text-sm font-medium
            text-orange-600
            border border-orange-200
            rounded-lg
            active:bg-orange-50
          "
        >
          Limpiar filtros
        </button>
      }
    </div>
  }

  <!-- PANEL DE ORDENAMIENTO (colapsable) -->
  @if(showSort()) {
    <div class="bg-white border-b border-gray-200 px-4 py-3">
      <div class="space-y-2">
        @for (option of sortOptions; track option){
          <button
            (click)="selectSort(option.value)"
            class="
              w-full h-10
              px-3
              flex items-center justify-between
              text-sm
              rounded-lg
              active:bg-gray-50
            "
            [class.text-orange-600]="sortBy() === option.value"
            [class.font-semibold]="sortBy() === option.value"
          >
            <span>{{ option.label }}</span>
            @if(sortBy() === option.value) {
              <lucide-icon [img]="Check" class="w-5 h-5" fill="currentColor"></lucide-icon>
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- LISTA DE PRODUCTOS -->
  <div class="flex-1 overflow-y-auto px-4 py-4">
    <!-- Contador de resultados -->
    <div class="mb-3">
      <p class="text-sm text-gray-600">
        {{ filteredProducts().length }} producto{{ filteredProducts().length !== 1 ? 's' : '' }}
      </p>
    </div>
    
    @if(viewMode() === 'list') {
      <app-products-list-list
        [products]="filteredProducts()"
        (productClick)="handleProductClick($event)"
        (addToCartClick)="handleAddToCart($event)"
      />
    }
    
    <!-- VISTA GRILLA -->
    @if(viewMode() === 'grid') {
      <app-products-list-grid
        [products]="filteredProducts()"
        (productClick)="handleProductClick($event)"
        (addToCartClick)="handleAddToCart($event)"
      />
    }
    
    <!-- Estado vac칤o -->
    @if(filteredProducts().length === 0) {
      <div class="text-center py-16">
        <div class="text-6xl mb-4">游댌</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          No encontramos productos
        </h3>
        <p class="text-gray-600 mb-4">
          Intent치 con otros filtros o b칰squeda
        </p>
        <button
          (click)="clearFilters()"
          class="
            px-6 py-2
            bg-orange-500 text-white
            rounded-xl
            font-medium
          "
        >
          Limpiar filtros
        </button>
      </div>
    }
  </div>
</div>

<!-- MODAL DE DETALLE DEL PRODUCTO (Bottom Sheet) -->
@if(selectedProduct()) {
  <app-product-details 
    [selectedProduct]="selectedProduct()!" 
    [categoria]="getCategoria(selectedProduct()!)"
    (close)="this.selectedProduct.set(null)"
  ></app-product-details>
}